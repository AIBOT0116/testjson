<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Shaka Player with ClearKey DRM</title>
    <link rel="shortcut icon" href="https://www.google.com/favicon.ico" type="image/x-icon">
    <!-- Shaka Player scripts and styles -->
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/controls.min.css">
    <style>
        body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif
        }

        #player-container {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%
        }

        .shaka-overflow-menu,
        .shaka-settings-menu {
            background-color: rgba(0, 0, 0, .54);
            backdrop-filter: blur(10px);
            border-radius: 8px
        }

        .shaka-overflow-menu button:hover,
        .shaka-settings-menu button:hover {
            background-color: rgba(126, 126, 126, .3)
        }

        .shaka-overflow-menu button,
        .shaka-settings-menu button {
            color: #fff;
            padding: 7px 6px
        }

        .shaka-overflow-button-label {
            color: #f5f5f5
        }

        .shaka-current-selection-span {
            color: #cacaca
        }

        .material-icons-round {
            color: #e6e6e6
        }

        .shaka-spinner-path {
            stroke: #fff
        }

        .shaka-controls-container[shown=true] .shaka-settings-menu {
            scrollbar-width: thin
        }

        @media only screen and (min-width:320px) and (max-width:940px) {
            .shaka-play-button {
                padding: calc(12% / 2)
            }
        }

        .h2 {
            margin: 20px 0 0 20px
        }

        a.channel-link {
            display: block;
            color: #ebebeb;
            font-size: 18px;
            text-decoration: none
        }

        #channel-list {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px
        }

        .match-item {
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            transition: transform .2s
        }

        .match-item:hover {
            transform: translateY(-5px)
        }

        .match-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 6px
        }

        .match-text {
            padding: 15px
        }

        .match-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            text-overflow: ellipsis
        }

        .match-info {
            font-size: 12px;
            color: #aaa;
            line-height: 1.4
        }

        .no-matches-message {
            grid-column: 1/-1;
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #ccc
        }

        .last-update {
            grid-column: 1/-1;
            text-align: right;
            font-size: 12px;
            color: #888;
            margin-bottom: 10px
        }

        @media (max-width:767px) {
            #channel-list {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 15px
            }

            .match-item {
                margin-bottom: 10px
            }

            .match-thumbnail {
                height: 150px
            }

            .match-text {
                padding: 12px
            }

            .match-title {
                font-size: 15px
            }

            .match-info {
                font-size: 11px
            }

            #player-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%
            }

            .shaka-video-container {
                width: 100% !important;
                height: 100% !important
            }

            .last-update {
                text-align: left;
                margin-bottom: 15px;
                font-size: 11px
            }
        }

        @media (min-width:768px) and (max-width:1023px) {
            #channel-list {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        .channel-link {
            display: block;
            padding: 8px
        }

        .match-title {
            white-space: normal;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }
    </style>
</head>

<body>
    <div id="main">
        <h2 class="h2">Available Matches</h2>
        <div id="channel-list">
            <div class="last-update" id="last-update"></div>
            <!-- rest of your content -->
        </div>
    </div>
    <div id="player-container" data-shaka-player-container>
        <video autoplay playsinline data-shaka-player id="video"
            poster="https://i.vimeocdn.com/video/1954341306-a080a511e7080f309b303845339d4d6ffe2ff7a48351f06116adee97d934ffe1-d?mw=900&mh=506"
            style="width:100%;height:100%"></video>
    </div>

    <script>
        let player;
        let matches = [];

        async function loadChannels() {
            try {
                const res = await fetch('https://raw.githubusercontent.com/drmlive/sliv-live-events/44c64/sonyliv.json');
                if (!res.ok) throw new Error('Failed to load channels.json');
                const data = await res.json();
                matches = data.matches || [];
                console.log("Matches loaded:", matches.map(m => m.contentId));
            } catch (err) {
                console.error("Error loading channel list:", err);
            }
        }

        function showChannelList() {
            const listContainer = document.getElementById("channel-list");
            const lastUpdateEl = document.getElementById("last-update");

            // Add last update time
            if (lastUpdateEl) {
                lastUpdateEl.textContent = "Last updated: " + (new Date()).toLocaleString();
            }

            if (!matches.length) {
                const noMatchMessage = document.createElement("div");
                noMatchMessage.className = "no-matches-message";
                noMatchMessage.textContent = "No live matches available at the moment.";
                listContainer.appendChild(noMatchMessage);
                return;
            }

            matches.forEach(match => {
                const container = document.createElement("div");
                container.className = "match-item";

                const link = document.createElement("a");
                link.href = `?ch=${match.contentId}`;
                link.className = "channel-link";

                const thumbnail = document.createElement("img");
                thumbnail.src = match.src || 'https://via.placeholder.com/300x180?text=No+Thumbnail';
                thumbnail.alt = match.match_name || match.event_name;
                thumbnail.className = "match-thumbnail";

                const textContent = document.createElement("div");
                textContent.className = "match-text";

                const title = document.createElement("div");
                title.className = "match-title";
                title.textContent = match.match_name || match.event_name;

                const channelInfo = document.createElement("div");
                channelInfo.className = "match-info";
                channelInfo.innerHTML = `
            <div>Channel: ${match.broadcast_channel}</div>
            <div>Category: ${match.event_category}</div>
            <div>Status: ${match.isLive ? '<span style="color:red">LIVE</span>' : 'Upcoming'}</div>
        `;

                textContent.appendChild(title);
                textContent.appendChild(channelInfo);

                link.appendChild(thumbnail);
                link.appendChild(textContent);
                container.appendChild(link);
                listContainer.appendChild(container);
            });
        }

        async function initPlayer(id) {
            const match = matches.find(m => m.contentId.toString() === id);
            if (!match) {
                alert("Match not found.");
                return;
            }

            const video = document.getElementById('video');
            const ui = video.ui;
            const controls = ui.getControls();
            player = controls.getPlayer();

            player.addEventListener('error', e => {
                console.error("Shaka error:", e.detail);
            });

            if (!shaka.Player.isBrowserSupported()) {
                alert("Browser not supported.");
                return;
            }

            const manifestUrl = match.video_url;

            // const baseProxy = "/";
            // let manifestPath = (match.video_url || "");
            // const manifestUrl = baseProxy + manifestPath;

            player.configure({
                streaming: {
                    rebufferingGoal: 2,
                    bufferingGoal: 30,
                    bufferBehind: 60,
                    ignoreTextStreamFailures: true,
                    inaccurateManifestTolerance: 0.3,
                    stallEnabled: false
                },
                manifest: {
                    dash: {
                        ignoreMinBufferTime: true,
                        autoCorrectDrift: true
                    }
                },
                abr: {
                    enabled: true
                }
            });

            ui.configure({
                controlPanelElements: ["play_pause", "mute", "volume", "spacer", "time_and_duration", "quality", "fullscreen", "overflow_menu"],
                volumeBarColors: {
                    base: 'rgba(50, 50, 50, 0.4)',
                    level: 'rgba(225, 225, 225, 0.8)'
                },
                seekBarColors: {
                    base: 'rgba(100, 100, 100, 0.6)',
                    buffered: 'rgba(200, 200, 200, 0.5)',
                    played: 'rgba(229, 9, 20, 1)'
                },
                enableKeyboardPlaybackControls: true
            });

            try {
                await player.load(manifestUrl);
                console.log("Playing match:", match.match_name);
            } catch (error) {
                console.error("Failed to load video:", error);
                alert("Failed to load video.");
            }
        }

        window.onload = async () => {
            await loadChannels();

            const params = new URLSearchParams(window.location.search);
            const id = params.get("ch");

            if (id) {
                const match = matches.find(m => m.contentId.toString() === id);
                if (match) {
                    document.getElementById("main").style.display = "none";
                    document.getElementById("player-container").style.display = "block";
                    await initPlayer(id);
                    return;
                }
            }
            showChannelList();
        };
    </script>
</body>

</html>
